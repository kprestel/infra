---
- hosts: pve_main
  become: true
  vars_files:
    - vars/vars.yml
  vars:
    - base_packages:
        - "python3"
        - "python3-virtualenv"
        - "zsh"
        - "python3-pip"
        - "vim"
        - "python3-apt"
        - "debhelper"
        - "libcapture-tiny-perl"
        - "libconfig-inifiles-perl"
        - "pv"
        - "lzop"
        - "mbuffer"
        - "git"
        - "virtualenv"
        - "zfs-zed"
        - "sudo"
        # - "samba"
  tasks:
    - name: Install a list of packages
      apt:
        pkg: "{{ base_packages }}"
    # TODO: check if debian
    - name: Install prerequisites
      apt:
        name: "{{ item }}"
        update_cache: yes
        state: latest
        force_apt_get: yes
      loop: ["aptitude"]
    # - name: Install base packages
    #   apt: name={{ item }} update_cache=yes state=latest
    #   loop: {{ base_packages }}

    - name: Upgrade all packages to the latest version
      apt:
        name: "*"
        state: latest

    - name: Update all packages to the latest version
      apt:
        upgrade: dist

    - name: Only run "update_cache=yes" if the last one is more than 3600 seconds ago
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Remove useless packages from the cache
      apt:
        autoclean: yes

    - name: Remove dependencies that are no longer required
      apt:
        autoremove: yes

    - name: Copy requirements
      copy:
        src: requirements.txt
        dest: /root/requirements.txt
        owner: root
        group: root

    - name: Install requirements
      pip:
        requirements: /root/requirements.txt
        virtualenv: /root/ansible/
        virtualenv_python: /usr/bin/python3

    - name: Crete vmstore fs
      zfs:
        name: tank/vmstore
        state: present
        extra_zfs_properties:
          atime: off
          relatime: on
    - name: Create trf group
      group:
        name: trf
        state: present
        system: no
    - name: Create jax user
      user:
        name: jax
        password: "$6$fhN84tCvnp$WH2kYbNDK9X4V5Ej0tptSy4FVuvcfCQLQhCSYh9mEf.7Ii391aBbu9OKm7SBYL5OUr.Ny7LDUEku.SnjJ4NDD."
        groups:
          - trf
        generate_ssh_key: true
        shell: "/usr/bin/zsh"
        state: present
    - name: Create kp user
      user:
        name: kp
        password: "$6$cSr3VQcI$QBSCJDwDdIWKZhu3110h0TCh60hVQ71mdTBHOhvXcUApaSOrH6VS3GXmf5A.uO61K8lVy2SXmpxrNQEw.UlyL."
        groups:
          - trf
          - sudo
        generate_ssh_key: false
        shell: "/usr/bin/zsh"
        state: present
    - name: Set kp authorized_users file
      authorized_key:
        user: kp
        state: present
        key: "{{ lookup('file', '/home/kp/.ssh/id_rsa.pub') }}"
