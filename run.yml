---
- hosts: all
  become: true
  vars_files: &vars
    - 'vars/vault.yml'
    - 'vars/vars.yml'
  tasks:
    - name: Remove Ubuntu motd spam
      file:
        path: "/etc/update-motd.d/{{ item }}"
        state: absent
      loop:
        - 80-livepatch
        - 95-hwe-eol
        - 50-motd-news
        - 10-help-text
      when: ansible_distribution == 'Ubuntu'

- hosts: all
  become: true
  roles:
    - role: geerlingguy.ntp
  vars_files:
    *vars
  tags: ntp


- hosts: master
  become: true
  vars_files:
    - 'vars/vault.yml'
    - 'vars/vars.yml'

  roles:
    - role: ksp.master
    - role: grog.package
    - role: geerlingguy.pip
    - role: rossmcdonald.telegraf
    - role: geerlingguy.samba
    - role: geerlingguy.nfs
    - role: arillso.restic
      vars:
        restic_create_cron: true
        restic_repos:
          back_blaze:
            location: "b2:prestel-backup:restic"
            password: "{{ restic_password }}"
            init: false
            b2_account_id: "{{ b2_account_id }}"
            b2_account_key: "{{ b2_account_key }}"
        restic_backups:
          tank:
            name: tank
            repo: back_blaze
            src: /tank
            scheduled: true
            schedule_hour: 3
            keep_last: 10


- hosts: docker
  become: true
  tags:
    - docker
  roles:
    - role: "nickjj.docker"

- hosts: homebridge
  become: true
  tasks:
    - name: "start up homebridge container"
      community.docker.docker_container:
        name: homebridge
        image: oznu/homebridge:latest
        network_mode: host
        pull: true
        restart_policy: always
        env:
          PUID: "1000"

- hosts: plexus
  become: true
  vars_files:
    - 'vars/vault.yml'
    - 'vars/vars.yml'
  roles:
    - role: ksp.plex

- hosts: hassio
  become: true
  vars_files:
    - 'vars/vault.yml'
    - 'vars/vars.yml'
  tasks:
    - name: copy loki config files
      ansible.builtin.copy:
        src: loki/
        dest: "{{ app_data_root }}/loki/"
        mode: "0755"
    - name: copy promtail config files
      ansible.builtin.copy:
        src: promtail/
        dest: "{{ app_data_root }}/promtail"
        mode: "0755"

  roles:
    - role: hadret.rsyslog
    - role: hadret.containers
    - role: ksp.docker-compose
      vars:
        - compose_file_env_path: ".env"
        - compose_build: true
        - compose_pull: true
        - compose_remove_images: "all"
        - compose_remove_orphans: "true"
      tags:
        - compose
        - docker

- hosts: localhost
  become: true
  tasks:
    - name: Create the `aur_builder` user
      ansible.builtin.user:
        name: aur_builder
        create_home: true
        group: wheel

    - name: Allow the `aur_builder` user to run `sudo pacman` without a password
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/11-install-aur_builder
        line: 'aur_builder ALL=(ALL) NOPASSWD: /usr/bin/yay'
        create: true
        validate: 'visudo -cf %s'
        mode: "0644"
